# -*- coding: utf-8 -*-
"""BaselinesTesting.ipynb

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1JSwCulz7OydRTORHg24A1D-BCmvJfFUQ
"""

!apt install swig cmake libopenmpi-dev zlib1g-dev
!pip install stable-baselines

import sys
import os
import numpy as np
import tensorflow as tf
import gym
import stable_baselines
from stable_baselines.common.cmd_util import make_atari_env
from stable_baselines.common.policies import CnnPolicy
from stable_baselines import PPO2

def pythonVersionString():
    """Current system python version as string major.minor.micro [(alpha|beta|etc)]"""
    vstring = "{0}.{1}.{2}".format(sys.version_info.major, sys.version_info.minor, sys.version_info.micro)
    if sys.version_info.releaselevel != "final":
        vstring += " ({})".format( sys.version_info.releaselevel )
    if sys.version_info.serial != 0:
        vstring += " (serial: {})".format( sys.version_info.serial )
    return vstring

def printVersion(module):
    if str(module) == "Python":
        print( "{}: {}".format( "Python", pythonVersionString() ) )
    else:
        print( "{}: {}".format( module.__name__, module.__version__) )

def printVersions( modules ):
    for module in modules:
        printVersion(module)
        
printVersions( ["Python", tf, np, gym, stable_baselines] )

from google.colab import drive
drive.mount('/content/gdrive')
!ls /content/gdrive/My\ Drive/ColabData/baseline_tests

# Initialize environments and model
base_dir = "/content/gdrive/My Drive/ColabData/baseline_tests"
stable_baselines.logger.configure(folder=base_dir, format_strs=['stdout', 'log', 'csv','tensorboard'])
model_path = os.path.join( base_dir, "test_1.pkl" )
num_envs = 2
random_seed = 0
env_names = [ 'DemonAttackNoFrameskip-v4', 'SpaceInvadersNoFrameskip-v4' ]
envs = []
for env_name in env_names:
    envs.append( make_atari_env(env_name, num_env=num_envs, seed=random_seed) )

if os.path.exists(model_path):
    print( "Loading model from {}".format( model_path ))
    model = PPO2.load(model_path)
else:
    print( "Creating model" )
    model = PPO2(CnnPolicy, envs[0], verbose=0)

def test_env( model, env, env_name, render=False, count=1000 ):
    obs = env.reset()
    reward_vec = []
    episodes = 0
    #name = env.unwrapped.get_attr( "venv" ).spec.id
    name = env_name # This is stupid. There should be some way to get the name from the multiply-wrapped env
    for i in range(count):
        action, _states = model.predict(obs)
        obs, rewards, dones, info = env.step(action)
        reward_vec.append(rewards)
        episodes += np.sum(dones)
        if render:
            env.render()
    print( "{} mean rewards/episodes: {}\t{}".format( name, np.mean(reward_vec), episodes))

epochs = 10
steps_per_epoch = 10000
for epoch in range(epochs):
    for idx, env in enumerate(envs):
        model.set_env(env)
        print( "training {} for {} steps".format( env_names[idx], steps_per_epoch) )
        model.learn(total_timesteps=steps_per_epoch)
        model.save(model_path)

    for idx, env in enumerate(envs):
        test_env( model, env, env_names[idx] )

"""Outputs from traiing runs
```
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0175	6
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.0165	11
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0165	8
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.0235	11
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0185	9
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.022	10
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0135	7
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.019	12
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0145	11
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.0215	11
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0235	7
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.02	11
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.015	11
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.026	10
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0145	3
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.022	14
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0095	5
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.0245	7
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0105	11
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.019	13
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0155	7
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.0235	7
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.026	9
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.0265	11
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0195	5
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.0265	11
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0215	7
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.0305	12
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0165	8
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.027	12
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.016	9
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.033	8
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0175	6
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.027	11
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.017	17
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.0395	7
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0155	7
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.0215	14
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0205	11
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.0265	8
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.019	9
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.0255	11
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.0145	5
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.0255	13
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.023	8
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.0205	15
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.019	8
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.022	11
training DemonAttackNoFrameskip-v4 for 10000 steps
training SpaceInvadersNoFrameskip-v4 for 10000 steps
DemonAttackNoFrameskip-v4 mean rewards/episodes: 0.021	7
SpaceInvadersNoFrameskip-v4 mean rewards/episodes: 0.0245	13

```
"""